<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Opening CODA…</title>

    <!-- iOS Smart Banner (replace app-id when live) -->
    <meta name="apple-itunes-app" content="app-id=0000000000" />

    <script>
      const params = new URLSearchParams(window.location.search);
      const path = params.get("path");

      // Safety: no path → go to homepage
      if (!path) {
        window.location.href = "/";
      }

      params.delete("path");
      const query = params.toString();
      const fullPath = query ? `${path}?${query}` : path;

      // Always redirect back to THIS domain
      const domain = window.location.origin;

      // Fallback store links (replace with REAL CODA store URLs when live)
      const iosStore = "https://apps.apple.com/pk/app/coda/whatsapp-messenger/id310633997";

      const androidStore =
        "https://play.google.com/store/apps/details?id=com.whatsapp";

      const ua = navigator.userAgent || navigator.vendor;
      let fallbackTimer;

      function openApp() {
        const iosScheme = `coda://${fullPath}`;
        const androidScheme = `intent://${fullPath}#Intent;scheme=coda;package=com.cwl.coda;end;`;

        if (/iPad|iPhone|iPod/.test(ua)) {
          // Try to open iOS app via scheme
          window.location.href = iosScheme;

          // If app not installed → open App Store
          fallbackTimer = setTimeout(() => {
            window.location.href = iosStore;
          }, 2000);
        } else if (/android/i.test(ua)) {
          // Try to open Android app via intent
          window.location.href = androidScheme;

          // If app not installed → open Play Store
          fallbackTimer = setTimeout(() => {
            window.location.href = androidStore;
          }, 2000);
        } else {
          // Desktop or unknown platform → stay on site
          window.location.href = domain;
        }
      }

      // If app actually opens, cancel fallback
      document.addEventListener("visibilitychange", () => {
        if (document.hidden && fallbackTimer) {
          clearTimeout(fallbackTimer);
        }
      });

      window.onload = openApp;
    </script>
  </head>

  <body>
    <p>Opening CODA…</p>
  </body>
</html>
